name: Complete Stack Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
      skip_infrastructure:
        description: 'Skip infrastructure deployment'
        required: false
        type: boolean
        default: false
      skip_backend:
        description: 'Skip backend deployment'
        required: false
        type: boolean
        default: false
      skip_frontend:
        description: 'Skip frontend deployment'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_infrastructure }}
    environment: ${{ inputs.environment }}
    outputs:
      backend_url: ${{ steps.get-outputs.outputs.backend_container_app_url }}
      swa_url: ${{ steps.get-outputs.outputs.swa_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        working-directory: ./Infra/${{ inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform init

      - name: Terraform Validate
        working-directory: ./Infra/${{ inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./Infra/${{ inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        working-directory: ./Infra/${{ inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: terraform apply -auto-approve tfplan

      - name: Get Infrastructure Outputs
        id: get-outputs
        working-directory: ./Infra/${{ inputs.environment }}
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          BACKEND_URL=$(terraform output -raw backend_container_app_url)
          SWA_URL=$(terraform output -raw static_web_app_url)

          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "swa_url=$SWA_URL" >> $GITHUB_OUTPUT

      - name: Infrastructure Summary
        run: |
          echo "## Infrastructure Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend URL:** ${{ steps.get-outputs.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend URL:** ${{ steps.get-outputs.outputs.swa_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Infrastructure deployed successfully" >> $GITHUB_STEP_SUMMARY

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    if: ${{ !inputs.skip_backend && !failure() && !cancelled() }}
    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore src/TimeApi/TimeApi.csproj

      - name: Build
        run: dotnet build src/TimeApi/TimeApi.csproj --configuration Release --no-restore

      - name: Build Docker image
        run: |
          docker build -t timeapi:${{ github.sha }} -f src/TimeApi/Dockerfile .
          docker tag timeapi:${{ github.sha }} timeapi:latest

      - name: Save Docker image
        run: |
          docker save timeapi:${{ github.sha }} | gzip > timeapi-${{ github.sha }}.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-backend
          path: timeapi-${{ github.sha }}.tar.gz
          retention-days: 1

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, build-backend]
    if: ${{ !inputs.skip_backend && !failure() && !cancelled() }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image-backend

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push to GHCR
        run: |
          REGISTRY="ghcr.io"
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="$REGISTRY/$REPO_LOWER/backend-api"
          IMAGE_TAG="${{ github.sha }}"

          docker load < timeapi-${{ github.sha }}.tar.gz
          docker tag timeapi:${{ github.sha }} $IMAGE_NAME:$IMAGE_TAG
          docker tag timeapi:${{ github.sha }} $IMAGE_NAME:latest

          docker push $IMAGE_NAME:$IMAGE_TAG
          docker push $IMAGE_NAME:latest

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Get Infrastructure Details
        id: get-infra
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          cd Infra/${{ inputs.environment }}
          terraform init

          RESOURCE_GROUP=$(terraform output -raw resource_group_name)
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT

      - name: Update Container App
        run: |
          RESOURCE_GROUP="${{ steps.get-infra.outputs.resource_group }}"
          REGISTRY="ghcr.io"
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="$REGISTRY/$REPO_LOWER/backend-api:latest"

          CONTAINER_APP_NAME=$(az containerapp list --resource-group $RESOURCE_GROUP --query "[?contains(name, 'backend')].name" -o tsv | head -n 1)

          if [ -n "$CONTAINER_APP_NAME" ]; then
            echo "Updating Container App: $CONTAINER_APP_NAME"
            az containerapp update \
              --name $CONTAINER_APP_NAME \
              --resource-group $RESOURCE_GROUP \
              --image $IMAGE_NAME
            echo "✅ Container App updated"
            sleep 30
          else
            echo "⚠️ Container App not found in resource group $RESOURCE_GROUP"
          fi

      - name: Backend Deployment Summary
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')

          echo "## Backend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ghcr.io/$REPO_LOWER/backend-api:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Backend deployed successfully" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend]
    if: ${{ !inputs.skip_frontend && !failure() && !cancelled() }}
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Get Infrastructure Details
        id: get-infra
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          cd Infra/${{ inputs.environment }}
          terraform init

          SWA_TOKEN=$(terraform output -raw static_web_app_api_key)
          SWA_URL=$(terraform output -raw static_web_app_url)
          BACKEND_URL=$(terraform output -raw backend_container_app_url)
          TENANT_ID=$(terraform output -raw azuread_tenant_id)
          BLAZOR_CLIENT_ID=$(terraform output -raw azuread_blazor_application_id)
          API_CLIENT_ID=$(terraform output -raw azuread_api_application_id)

          echo "swa_token=$SWA_TOKEN" >> $GITHUB_OUTPUT
          echo "swa_url=$SWA_URL" >> $GITHUB_OUTPUT
          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "tenant_id=$TENANT_ID" >> $GITHUB_OUTPUT
          echo "blazor_client_id=$BLAZOR_CLIENT_ID" >> $GITHUB_OUTPUT
          echo "api_client_id=$API_CLIENT_ID" >> $GITHUB_OUTPUT

      - name: Configure Blazor App Settings
        run: |
          CONFIG_FILE="src/TimeClockUI/wwwroot/appsettings.Production.json"

          echo "Updating $CONFIG_FILE with deployment values..."

          # Replace placeholders with actual values
          sed -i "s|BACKEND_URL_PLACEHOLDER|${{ steps.get-infra.outputs.backend_url }}|g" $CONFIG_FILE
          sed -i "s|TENANT_ID_PLACEHOLDER|${{ steps.get-infra.outputs.tenant_id }}|g" $CONFIG_FILE
          sed -i "s|BLAZOR_CLIENT_ID_PLACEHOLDER|${{ steps.get-infra.outputs.blazor_client_id }}|g" $CONFIG_FILE
          sed -i "s|API_CLIENT_ID_PLACEHOLDER|${{ steps.get-infra.outputs.api_client_id }}|g" $CONFIG_FILE

          echo "Configuration updated:"
          cat $CONFIG_FILE

      - name: Restore dependencies
        run: dotnet restore src/TimeClockUI/TimeClockUI.csproj

      - name: Build Blazor WASM
        run: |
          dotnet publish src/TimeClockUI/TimeClockUI.csproj \
            -c Release \
            -o publish \
            /p:RunAOTCompilation=false

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.get-infra.outputs.swa_token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: 'publish/wwwroot'
          skip_app_build: true
          skip_api_build: true

      - name: Frontend Deployment Summary
        run: |
          echo "## Frontend Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** ${{ steps.get-infra.outputs.swa_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Frontend deployed successfully" >> $GITHUB_STEP_SUMMARY

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend, deploy-frontend]
    if: ${{ !failure() && !cancelled() }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Get URLs
        id: get-urls
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_USE_OIDC: true
        run: |
          cd Infra/${{ inputs.environment }}
          terraform init

          BACKEND_URL=$(terraform output -raw backend_container_app_url)
          SWA_URL=$(terraform output -raw static_web_app_url)

          echo "backend_url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "swa_url=$SWA_URL" >> $GITHUB_OUTPUT

      - name: Test Backend Health
        run: |
          BACKEND_URL="${{ steps.get-urls.outputs.backend_url }}"

          echo "Testing backend at $BACKEND_URL"

          sleep 15

          for i in {1..5}; do
            if curl -f -s "$BACKEND_URL/health" || curl -f -s "$BACKEND_URL" ; then
              echo "✅ Backend health check passed"
              break
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done

      - name: Test Frontend Health
        run: |
          SWA_URL="${{ steps.get-urls.outputs.swa_url }}"

          echo "Testing frontend at $SWA_URL"

          sleep 15

          for i in {1..5}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SWA_URL")
            if echo "$HTTP_CODE" | grep -q "200\|301\|302"; then
              echo "✅ Frontend health check passed (HTTP $HTTP_CODE)"
              break
            fi
            echo "Attempt $i failed (HTTP $HTTP_CODE), retrying..."
            sleep 10
          done

      - name: Smoke Tests Summary
        run: |
          echo "## Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** ${{ steps.get-urls.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** ${{ steps.get-urls.outputs.swa_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Smoke tests completed" >> $GITHUB_STEP_SUMMARY

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend, deploy-frontend, smoke-tests]
    if: always()

    steps:
      - name: Complete Summary
        run: |
          echo "## Complete Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed At:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.smoke-tests.result }}" = "success" ]; then
            echo "✅ **Full stack deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Deployment completed with some issues**" >> $GITHUB_STEP_SUMMARY
          fi
