name: 'Build and Push Docker Image'
description: 'Build Docker image and optionally push to registry'

inputs:
  dockerfile:
    description: 'Path to Dockerfile'
    required: true
  context:
    description: 'Build context path'
    required: true
  image-name:
    description: 'Image name (without registry)'
    required: true
  image-tag:
    description: 'Image tag'
    required: true
  registry:
    description: 'Container registry'
    required: false
    default: 'ghcr.io'
  registry-username:
    description: 'Registry username'
    required: false
  registry-password:
    description: 'Registry password/token'
    required: false
  push-to-registry:
    description: 'Push image to registry'
    required: false
    default: 'false'
  save-artifact:
    description: 'Save image as artifact'
    required: false
    default: 'false'
  artifact-name:
    description: 'Artifact name for saved image'
    required: false

outputs:
  image-full-name:
    description: 'Full image name with registry and tag'
    value: ${{ steps.build.outputs.full-name }}

runs:
  using: 'composite'
  steps:
    - name: Log in to Container Registry
      if: ${{ inputs.push-to-registry == 'true' }}
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Build Docker Image
      id: build
      shell: bash
      run: |
        FULL_IMAGE_NAME="${{ inputs.registry }}/${{ inputs.image-name }}:${{ inputs.image-tag }}"

        docker build \
          -t ${{ inputs.image-name }}:${{ inputs.image-tag }} \
          -f ${{ inputs.dockerfile }} \
          ${{ inputs.context }}

        if [ "${{ inputs.push-to-registry }}" == "true" ]; then
          docker tag ${{ inputs.image-name }}:${{ inputs.image-tag }} $FULL_IMAGE_NAME
          docker tag ${{ inputs.image-name }}:${{ inputs.image-tag }} ${{ inputs.registry }}/${{ inputs.image-name }}:latest
        fi

        echo "full-name=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT
        echo "Docker image size: $(docker images ${{ inputs.image-name }}:${{ inputs.image-tag }} --format '{{.Size}}')"

    - name: Push to Registry
      if: ${{ inputs.push-to-registry == 'true' }}
      shell: bash
      run: |
        docker push ${{ inputs.registry }}/${{ inputs.image-name }}:${{ inputs.image-tag }}
        docker push ${{ inputs.registry }}/${{ inputs.image-name }}:latest

    - name: Save Docker Image as Artifact
      if: ${{ inputs.save-artifact == 'true' }}
      shell: bash
      run: |
        docker save ${{ inputs.image-name }}:${{ inputs.image-tag }} | gzip > ${{ inputs.artifact-name }}.tar.gz
